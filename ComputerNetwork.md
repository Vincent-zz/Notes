# 计算机网络  

## 网络概述

### 网络的组成

---

- 结点（node）：每台独立计算机是一个结点
- 链路（link）：链接结点

### 互联网（internet - "network of network"）

---

- 网络
- 路由器：互联网络

### 因特网（Internet） 

---

因特网是最大的互联网，采用TCP/IP协议族作为通信规则 

因特网协会（ISOC）：全面管理因特网的国际协会 

Internet组成 

- 边缘部分：各种电脑、服务器、手机、物联网智能硬件
- 核心部分：大量网络与路由器组成，为边缘部分提供服务
  
**ISP（Internet service provider）** 

个人用户通过ISP接入Internet，ISP收费提供IP地址、路由器 

Internet基于ISP可被分成多层结构，如第一层国际性区域主干网ISP，第二层国家性ISP（多为大公司，如电信、联通、移动），第三次区域性ISP，……，直到个人、企业网、校园网等用户（实际上，ISP结构已日渐复杂） 

每个用户只要能连入Internet都有条件成为ISP 

### 网络的分类

---

- 交换技术
  - 电路交换网络
  - 报文交换网络
  - 分组交换网络
- 使用者
  - 公用网（公众网）
  - 专用网（如军队网络）
- 覆盖范围
  - 广域网WAN：覆盖区域很大，全球、国家级网络，是因特网的核心部分
  - 城域网MAN：城市骨干网，互联企业、校园局域网等
  - 局域网LAN：小范围，楼栋、校园，现在的校园网大多互联了多个局域网
  - 个域网PAN：连接个人电子设备，如鼠标、打印机
- 传输介质
  - 有线网
  - 无线网
- 拓扑结构
  - 总线型
  - 星型
  - 环型
  - 网状型

### 路由器：分组交换 

---

用户段的消息全体数据（“报文”）被分解为大量等长的小数据段 

小数据段加上一个由必要信息（如目的地址、顺序信息、应用进程等）构成的首部，成为一个“分组”，又称“包”（首部又称“包头”） 

各个分组经过互联网中的各个分组交换机（路由器）转发（逻辑上，实际上是包->帧->比特再传输，见下文）到接收端用户（各个分组经过的路径大多各不相同，到达的顺序也是混乱的） 

接收端将各分组重新组合还原报文 

路由器在分组交换中的任务

- 缓存分组
- 转发分组

### 计算机网络性能指标 

---

- 速率（比特率、数据率）：连接于网络上的*主机在信道上*传输比特的速率（单位：bps）
- 带宽（最高数据率）：由模拟系统频率的范围而来，表示计算机网络*信道*传输数据的能力（单位：bps）
- 吞吐量：单位时间内通过*某网络或某接口*的数据量，受带宽与额定速率限制（单位：bps）
- 时延
  - 发送时延（源主机）：`分组长度（b）/发送速率（bps）`，发送速率受网卡速率、信道带宽、路由器接口速率限制
  - 传播时延（信道）：`信道长度（m）/信号传输速率（m/s）`
  - 处理时延（路由器）：动态变化，难以计算
- 时延带宽积：`传播时延（s）*带宽（bps）`，表示以比特为单位的链路长度（单位：b）
- 往返时间（RoundTripTime）：源主机发送分组到收到目标主机发送回来的分组的时间
- 利用率
  - 信道利用率：某信道被利用的时间百分比，太低浪费资源，太高会增大处理时延，主干信道大多保持在50%以下
  - 网络利用率：全网所有信道利用率的加权平均
- 丢包率：一定时间范围内丢失的分组的比例，传输过程中出现误码（被结点丢弃）或接口路由器缓冲区已满（通信量过大，网络拥塞）会造成丢包，所有丢包率一定程度上反映了网络拥塞程度

\* 作为速率单位时 1 Tbps = *10*^3 Gbps = *10*^6 Mbps = *10*^9 kbps = *10*^12 bps 

\* 对n个等长分组经由多个带宽相同的链路的总时延的计算（处理时延不计）实际上只需考虑：
- 最开始发送第一个分组到最开始发送最后一个分组间的n - 1个发送时延
- 外加最后一个分组发送、传播的总时延即可 

## 计算机网络体系结构 

### 常见体系结构 

---

- 法律上的国际标准：OSI体系（7层）
- 实际上的国际标准：TCP/IP体系（4层，路由器一般仅包含以下前两层），能够接入因特网的主机操作系统中有着符合TCP/IP体系标准的TCP/IP协议族
  - 网络接口层：无具体内容，可以互联各种接口
  - 网际层：IP协议为核心协议，负责互联接口层的不同接口（IP over everything），在IP向运输层协议提供互联服务的基础上运输层协议向应用层协议提供服务（everything over IP）
  - 运输层：TCP（稳定）、UDP（不稳定）协议为重要协议
  - 应用层：各种应用协议，如HTTP、SMTP、DNS、RTP……
- 用于教学的原理结构：将TCP/IP的接口层分为物理层与数据链路层（5层，路由器为前三层）

**体系结构的大致运作方式例** 

总的来说就是反反复复、层层加码、层层解码 

用户主机的应用层的浏览器生成符合http协议的请求报文， 

报文逐层处理加工（应用层到运输层到网际层到链路层到物理层）， 

由物理层传到服务器，服务器又逐层解读报文（物理层到链路层到网际层），获取目的地信息， 

再重新逐层加工（网际层到链路层到物理层），发送到下一个接口， 

最终网页服务器收到报文，逐层解读报文（物理层到链路层到网际层到运输层到应用层），在应用层得到请求报文，生成响应报文，再以同样的方式发送回用户主机 

### 网络体系结构的一些概念

---

- 实体：任何可收发信息的软硬件，处在同一层次的实体又称对等实体
- 协议：对等实体间进行（*逻辑上的*）通信的规则的集合
  - 语法：要交换的信息的格式
  - 语义：定义对应语法通信双方所要进行的操作
  - 同步：定义收发双方的时序关系
- 服务：对等实体在协议控制下对下一层提供服务，同理，协议的实现需要上一层提供的服务来实现（*下一层并不在乎上一层使用的是何种协议，只要提供了本层协议实现所需的服务即可*）
  - 服务访问点：指相邻两层实体间交换信息的逻辑接口，如数据链路层的帧、网络层IP首部中的协议字段、运输层的端口号
  - 服务原语：层之间为获取服务所需交换的命令
- PDU协议数据单元：对等层次间（*逻辑上*）交换的数据包，如比特流（物理层）、帧（链路层）、IP数据报又称分组又称包（网路层），TCP、UDP报文（运输层），报文（应用层）
- SDU服务数据单元：同一系统层与层之间交换的数据包，多个SDU可合成一个PDU

## 物理层 

### 物理层的基本概念 

---

物理层解决通过传输媒体传输比特流的问题，为数据链路层提供服务（为数据链路层屏蔽了各种传输媒体的差异） 

物理层协议的主要任务

- 机械特性：接口引脚个数、接头型号尺寸等等
- 电气特性：各电缆上的电压等
- 功能特性：高低电平的携带的信息、意义
- 过程特性：不同功能、可能事件发生的过程、顺序

### 传输媒体 

---

- 导引型传输媒体：同轴电缆、双绞线（绞合是为了抗电磁干扰）、光纤、电力线等
- 非导引型传输媒体：无线电波、微波、红外线、可见光等 

### 传输方式 

---

（1）

- 串行传输：单线例如计算机网络的信息传输
- 并行传输：多线例如CPU内部总线

（2）

- 同步传输：稳定的比特流传输，字节之间同步、无间隔，接收端以一定频率读取字节中某位特定比特的信息，需要同步收发双方*时钟*（例如以固定频率的方波为时钟，每到上升沿接收端就读取此刻数据线中的信息）
  - 内同步：将时钟信号编码入待发送的数据
  - 外同步：另设一条时钟信号线（然而时钟信号与数据信号因为各种传输线的电导率、长度等物理特性不同，难免产生*时钟相位*的偏移，可能造成错误的数据读取）
- 异步传输：以独立的字节（外加起始位和结束位）为单位传输，字节之间异步、间隔不定（但每个字节内的比特是同步的），接收端在每个字节起始处同步

（3）

- 单工：一条信道单向传输数据，如收音机
- 半双工：两条信道可双向传输，但不能同时，如对讲机
- 全双工：两条信道可同时双向传输数据，如电话

### 编码与调制 

---

- 编码：转为数字信号
  - 不归零：码元为连续的正或负，存在同步问题
  - 归零：码元先为正或负后归零，以零为时钟实现内同步，但浪费带宽
  - 曼彻斯特（传统以太网使用）：码元为正到负或负到正，其中间的上升沿、下降沿同时代表时钟与数据
  - 差分曼彻斯特：码元中的上升沿、下降沿仅代表时钟，以码元起始电平（相比上一个码元结束电平）是否发生变化表示数据
- 调制：转为模拟信号
  - 基本调制方法：每个码元只能传输一位数据
    - 调幅（AM）
    - 调频（FM）
    - 调相（PM）
  - 混合调制：混合调制振幅、频率与相位，例如正交振幅调制（QAM），达到一个码元多位数据的效果

\* 曼彻斯特编码如何实现同步（相邻码元之间也可能存在上升沿或下降沿）？相邻升降沿间的间隔要么半个码元要么一个码元，接收端会识别这两种间隔，仍然可以获取正确的时钟信号 

### 信道的极限容量 

---

**奈氏准则** 

- 理想低通信道最高码元传输速率：2W Baud = 2W 码元/s 
- 理想带通信道最高码元传输速率：1W Baud = 1W 码元/s 

\* 信道频率带宽：W Hz，此带宽非网络性能指标中的彼带宽 


**香农定理**（考虑高斯噪声）

$$c = W \log _ 2(1 + \frac{S}{N})$$
c：信道极限传输速率（单位：bps） 

W：信道频率带宽 

S：信号平均功率 

N：高斯噪声功率 

信噪比（单位：dB）： 

$$ 10 \lg(\frac{S}{N}) $$ 

为提高信道容量，根据奈氏准则，应当增大调制速度（每个码元的比特数）；根据香农定理，应当增大信噪比 

## 数据链路层 

### 关于帧 

---

**封装**： 

对上层的协议数据单元（也就是网路层的包）添加帧头、帧尾，封装成帧 

数据部分相比帧头帧尾越大传输效率越高 

**读取**： 

从比特流中分离出帧，不同的链路层协议对应不同的分离方法，如PPP帧的帧头帧尾包含特定标志用来界定帧，以太网V2的MAC帧在物理层会加入前导码并规定帧之间的时间间隔 

**透明传输**： 

数据链路层对于帧头帧尾中间的数据应当无任何限制 

可能出现的问题：PPP帧内部的数据中有一段与帧尾标志相同的数据，则这个帧传输到接收端时将无法完整读取 

解决方法

- 字节填充：扫描帧，在其中与界定帧标志相同的字节前（以及与转义字符相同的字节前）加入转义字符
- 比特填充：如HDLC协议的界定标志为01111110，则在帧中每五个连续的1后插入一个0

### 关于数据链路层与物理层貌似有些混乱的关系 

---

个人理解： 

关键在于把*将比特流读取为帧*的这一过程划归于那一个层，因为读取时是会用到链路层协议的，如果仅仅将物理层视为负责传输的一层，读取归于链路层，那么两层间的协议可以独立、透明，与其他层间的协议一致；若要将读取归于物理层，物理层给链路层提供帧这种协议数据单元，这又与其他层间提供服务的关系（如链路层为网际层提供包）一致。 

个人倾向于前者， 但毕竟在TCP/IP体系中两个层是一体的，所以感觉也没啥必要把这两个层分辨得过于明晰，有些时候不妨还是以接口层统一看待更好 

### 差错与可靠传输 

---

**差错类型**

- 物理上：比特差错 
  - 奇偶校验：so咦贼，容易漏检
  - 循环冗余校验（CRC）：多项式、余数……，不容易漏检，非常易于硬件实现，广泛用于数据链路层
- 网络上：分组丢失、分组重复、分组失序等

**可靠传输**

- 不可靠传输：仅丢弃被检测出的误码
- 可靠传输：想办法实现收发双方信息完全一致

\* 可靠传输的概念不仅限于接口层，网际层、运输层对其各自上层均有类似概念，以下将帧、分组等都用分组代替 

对于接口层

- 有线传输时，误码率低，一般并不要求对上层（即网际层）提供可靠传输服务
- 无线传输时，易受干扰，误码率高，要求对上层（即网际层）提供可靠传输服务

**可靠传输的实现机制**

- 停止-等待协议SW：
  - 基本机制：发送方每发送一个分组就停下等待接收方发回确认（ACK）或否认（NAK）分组
  - 超时重传：用来应对发送方的发现送的分组丢失了导致收不到反馈的情况
  - 对数据分组编号：对分组添加1比特的“序号”位，每个分组的序号与上一个不同，用来应对确认分组丢失导致分组重复的问题
  - 对确认分组编号：应对确认分组迟到，重传的数据被接受后产生重复的确认分组，造成重复确认的情况
  - 缺点：信道利用率低
- 回退N帧协议GBN
  - 基本机制：维持一个发送窗口与接收窗口，SW的升级版（信道利用率更高），每次可连续发送一定数量的分组（将这个数量定义为窗口大小$W_T$），接收方接收窗口大小仍与SW一致（$W_R = 1$）
  - 编号：n位编号，发送窗口大小满足$1 \le W_T \le 2^n - 1$（$n = 1$时为SW），一次发送$W_T$个分组，而$W_R$始终为1，每接收1个无误码且编号一致的分组接收窗口中的编号后移1位
  - $W_T$超过上限，例如$n = 3$时，$W_T$取8，0~7号分组被发送接收，接收端返回的$ACK_7$丢失，超时后重复发送，而此时接收窗口中序号为0，那么将会重复接收相同的几个分组，并且接收端毫无察觉
  - 累计确认：接收端并不一定逐个确认，而是每接收几个分组发送一个$ACK_n$，表示序号n以前的都被成功接收，（然后发送窗口起始位置后移到n的后一位序号）即使有一个确认分组丢失，但收到了下一个确认分组，那么仍不必重传
  - 缺点：发送窗口中一组分组抵达接收端，第一个出现误码，接收窗口不后移，会导致后面的被丢弃，仍要再传输一遍（即回退N帧），此时信道利用率并不高
- 选择重传协议SR
  - 基本机制：$W_R > 1$，避免退回N帧

### 点对点协议PPP（Point-to-Point Protocal） 

---

PPP是目前使用最广泛的数据链路层点对点协议，比如用户和ISP之间通信、广域网服务器中的专用线路通信在数据链路层都是使用PPP 

PPP协议主要由三部分构成
- 帧的封装方法
- 链路控制协议LCP：面向物理层，用于配置、检测链路的连接
- 一套网络控制协议NCPs：面向网络层，其中每一个协议用于支持对应的网络层协议

**PPP帧格式**： 

首部（按在帧中的排列顺序）
- Flag：1字节，取值0x7E，为PPP帧的界定符
- Address：1字节，取值0xFF，预留（目前没用）
- Control：1字节，取值0x03，预留（目前没用）
- Protocol：2字节，指明帧数据内容遵守的协议
  - 0x0021：帧的内容为IP数据报
  - 0xC021：帧的内容为LCP分组
  - 0x8021：帧的内容为NCP分组
  
尾部

- FrameCheckSequence：2字节，是使用循环冗余校验算出的的校验位
- Flag:界定符
  
**PPP协议的使用**： 

接收端检测到信号，使用LCP分组配置，成功则建立链路，再交换NCP分组进行配置，进入“打开”状态，可以通信 

**其他**：

PPP帧实现透明传输采用的方法由链路决定（面向字节的异步链路：字节填充；面向比特的同步链路：比特填充） 

PPP帧向上不提供可靠传输服务（出现差错即丢弃） 

### 媒体接入控制（Medium Access Control） 

---

协调多个发送点与接收站共用同一个传输媒体 

**MAC方法** 

- 静态划分信道：信道复用（multiplex），频分复用、时分复用、波分复用、码分复用（CodeDivisionMultiple每个站都分配不同的码片Chip，出1则出码片，出0则出码片反码）
- 动态接入控制：
  - 受控接入
  - 随机接入：总线型局域网CSMA/CD（Carrier Sense Multiple Access/Collision Detection）；无线局域网CSMA/CA（Avoidence）

**MAC地址** 

MAC地址/局域网地址（LAN Address）/以太网地址（Ethernet Address）/物理地址（Physical Address） 

- 以太网MAC子层使用的地址，用于媒体接入控制（MAC），属于数据链路层，收发端的MAC地址封装在帧中
- MAC地址一般被固化在网卡ROM中，所以又称硬件地址
- 被称为物理地址，但不属于物理层
- 是对各个网络接口（有线网卡、wifi接口、蓝牙接口……）的全球唯一标识（所以路由器有许多MAC地址）
- 六个字节构成（常表示为6组2位十六进制数）
  - 前三个字节：组织唯一标识符OUI（厂商向IEEE注册，于是可据此查得生产此网络设备的厂商）
  - 后三个：EUI，厂商自行分配

IP地址：TCP/IP体系网际层使用的地址，具备区分网络的功能（MAC地址不具备） 

在数据包在网络中传输时，发送端与接收端IP地址始终不变，而发送端与接收端MAC地址却会变化。传输过程中数据包中转过多个接口，每次中转（抵达某路由器接口，再发向下一个接口）数据包在链路层中封装的发送端、接收端MAC地址都会改变 

**地址解析协议ARP** 

已知IP地址获得MAC地址的协议 

每个主机都有一个ARP高速缓存表，记录一系列IP地址对应的MAC地址（动态获取的记录2分钟会自动删除） 

ARP实现过程： 

对于发送端，首先查看自己的ARP高速缓存，有则可以直接发送，无则如下步骤 

由于接收端的MAC地址是未知的，所以无法封装帧，那么发送端会广播一个ARP请求报文（内含自己的IP、MAC以及接收端的IP），请求报文封装成帧时将目的MAC地址设为广播地址，该网络总线上所有主机都能收到 

总线上主机收到ARP报文之后如果报文请求的IP与自己一致，则先在自己的ARP缓存中记下该路由器的IP、MAC，并回复一个响应单播帧（内含自己的IP、MAC） 

发送端收到之后将接收端的IP、MAC记录到自己的高速缓存中，然后就可以直接发送了 

\* ARP协议是链路层级的，无法跨网络使用，互联网真实传输路径中ARP是逐段链路进行的 

### 集线器（HUB）与交换机（SWITCH） 

---

交换机是目前以太网使用最广泛的设备，工作在数据链路层（与物理层）；集线器是早期以太网设备，工作在物理层，已逐渐被淘汰 

交换机根据MAC地址进行帧的转发，交换机隔离碰撞域（交换机的每一个接口是一个独立的碰撞域）但不隔离广播域 

以太网交换机通电即可使用，用自学习算法自动建立帧交换表（帧交换表记录了各个MAC地址对应的接口号） 

自学习：先登记发送端的MAC地址与接口号，再搜索接收端MAC地址对应的接口号，找不到就盲目泛洪（对每一个接口转发） 

多个交换机连接在一起形成交换式以太网，此时存在帧交换表中多个MAC地址对应同一个接口的情况 

对于交换机，MAC地址与接口的对应关系是时常改变的，所以帧交换表中的每条记录一段时间后会自动删除 

**以太网交换机的生成树协议STP** 

冗余链路：提高网络可靠性，但会产生网络环路（带来广播风暴、帧交换表震荡等问题） 

生成树算法：使交换机自动构建没有网络环路的逻辑网络（不管实际物理连接如何） 

### 虚拟局域网VLAN 

---

路由器是网络层设备，可以隔离广播域（不转发任何广播数据报），避免巨大的广播域产生广播风暴，但是路由器成本较高，全部使用路由器隔离广播域是不现实的，于是VLAN技术应运而生 

VLAN的实现要求交换机满足两个功能

- 能处理带有VLAN标记的帧（IEEE802.1Q帧）
- 交换机各端口可以支持不同的端口类型（Access、Trunk、Hybrid）

## 网际层

### 概述 

---

网际层的主要任务：实现各个网络的互连，以路由器作为各个网络之间的互连节点（网关） 

三个要解决的主要问题

- 向运输层提供可靠还是不可靠服务
- 网络寻址问题
- 路由选择问题

网际层提供的两个服务

- 面向连接的虚电路服务
  - 可靠通信由网络保证
  - 必须建立网络层连接
- 无连接的数据报服务
  - 可靠通信由用户主机保证
  - 不需建立网络层连接
  - 每个分组可走不同路径
  - 存在误码、丢失、失序等差错
  - 因特网的设计思路，复杂功能置于互联网边缘，简单功能置于互联网核心，大大降低网络造价，使得网络的运用更加灵活

### IPv4 

---

IPv4地址：给因特网中的每一台主机、路由器接口分配一个在世界范围内唯一的32位比特标识符 

IPv4地址表示方法：点分十进制（8位一组用十进制表示，`.`隔开） 

**分类编址** 

- A类：网络号8位（0...），主机号24位
- B类：网络号16位（10...），主机号16位
- C类：网络号24位（110...），主机号8位
- D类：多播地址（1110...）
- E类：保留地址（1111...）

注意

- 只有A、B、C类可分配
- 主机号全0为网络地址，不可分配
- 主机号全1为广播地址，不可分配
- 一些特定网络号不可分配（本地环回测试地址）

**划分子网** 

主机号中分出一部分作为子网号，网络号子网号相同的主机位于同一网段 

子网掩码：32位，表示主机号中有多少位被用作表示子网号 

将IPv4中网络号与子网号全1，剩余全0得到子网掩码，于是子网掩码与IPv4逐位与就得到网络地址 

**无分类编址** 

数量巨大的C类网因主机号太少无法得到充分使用，于是有了CIDR地址 

CIDR消除了传统的ABC类与子网的概念，在IPv4后面加上`/网络前缀的位数`，相同网络前缀的地址组成一个“CIDR地址块” 

路由聚合（构造超网）：大量主机在路由器中对应同一接口，那么路由器只需记下它们共同网络前缀与接口的对应关系即可，无需对每个IP地址建一条记录；聚合地址块越长路由越具体，转发时向最长匹配聚合地址块的接口转发 

应用规划

- 定长子网掩码
- 变长子网掩码：划分灵活，按需分配
